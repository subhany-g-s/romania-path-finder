<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Romania Path Finder - AI Search Algorithms</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .slide-down {
            animation: slideDown 0.4s ease-out;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #map {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .map-container {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .map-container.show {
            display: block;
            opacity: 1;
        }

        select, input {
            transition: all 0.3s ease;
        }

        select:focus, input:focus {
            transform: scale(1.02);
        }

        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 10px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Hero Section -->
    <div class="gradient-bg text-white py-16 px-4">
        <div class="max-w-6xl mx-auto text-center fade-in">
            <div class="mb-4">
                <i class="fas fa-map-marked-alt text-6xl mb-4"></i>
            </div>
            <h1 class="text-5xl font-bold mb-4">Romania Path Finder</h1>
            <p class="text-xl text-purple-100">Find the best route across Romania using AI search algorithms</p>
            <div class="mt-6 flex justify-center gap-4 flex-wrap">
                <span class="badge bg-white bg-opacity-20 backdrop-blur-sm">
                    <i class="fas fa-brain mr-2"></i>7 Algorithms
                </span>
                <span class="badge bg-white bg-opacity-20 backdrop-blur-sm">
                    <i class="fas fa-city mr-2"></i>20 Cities
                </span>
                <span class="badge bg-white bg-opacity-20 backdrop-blur-sm">
                    <i class="fas fa-route mr-2"></i>Real-Time Visualization
                </span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto px-4 py-8">
        <!-- Search Form Card -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8 card-hover slide-down">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-search text-purple-600 mr-3"></i>
                Configure Your Route
            </h2>
            
            <form method="POST" id="pathForm" class="space-y-6">
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Start City -->
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fas fa-play-circle text-green-500 mr-2"></i>Start City
                        </label>
                        <select name="start" required 
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none">
                            {% for city in cities %}
                            <option value="{{ city }}">{{ city }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Goal City -->
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fas fa-flag-checkered text-red-500 mr-2"></i>Goal City
                        </label>
                        <select name="goal" required 
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none">
                            {% for city in cities %}
                            <option value="{{ city }}" {% if city == 'Bucharest' %}selected{% endif %}>{{ city }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Algorithm Selection -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">
                        <i class="fas fa-cogs text-blue-500 mr-2"></i>Search Algorithm
                    </label>
                    <select name="algo" id="algo" required 
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none">
                        <option value="ASTAR">A* Search (Optimal & Efficient)</option>
                        <option value="BFS">Breadth-First Search</option>
                        <option value="DFS">Depth-First Search</option>
                        <option value="UCS">Uniform Cost Search</option>
                        <option value="GREEDY">Greedy Best-First Search</option>
                        <option value="DLS">Depth-Limited Search</option>
                        <option value="AO*">AO* Search</option>
                    </select>
                </div>

                <!-- Conditional Options -->
                <div id="depthLimitInput" class="hidden">
                    <label class="block text-gray-700 font-semibold mb-2">
                        <i class="fas fa-layer-group text-orange-500 mr-2"></i>Depth Limit
                    </label>
                    <input type="number" name="limit" min="1" value="4" 
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none">
                </div>

                <div id="showOptionContainer" class="hidden">
                    <label class="block text-gray-700 font-semibold mb-2">
                        <i class="fas fa-filter text-indigo-500 mr-2"></i>Display Option
                    </label>
                    <select name="option" 
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none">
                        <option value="all">All Paths</option>
                        <option value="shortest">Shortest Path (Fewest Cities)</option>
                        <option value="lowest">Lowest Cost Path (Optimal)</option>
                    </select>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-4 pt-4">
                    <button type="submit" 
                            class="flex-1 btn-primary text-white font-bold py-4 px-6 rounded-lg flex items-center justify-center">
                        <i class="fas fa-route mr-2"></i>Find Path
                    </button>
                    <button type="button" onclick="resetForm()" 
                            class="px-6 py-4 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold rounded-lg transition-all">
                        <i class="fas fa-redo mr-2"></i>Reset
                    </button>
                </div>
            </form>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="hidden text-center py-8">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-600 font-semibold">Finding optimal path...</p>
        </div>

        <!-- Results Section -->
        {% if result %}
        <div class="space-y-6 fade-in">
            <!-- Summary Cards -->
            <div class="grid md:grid-cols-3 gap-6">
                <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-gray-600 font-semibold">Algorithm</h3>
                        <i class="fas fa-microchip text-purple-500 text-2xl"></i>
                    </div>
                    <p class="text-2xl font-bold text-gray-800">{{ algorithm_name }}</p>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-gray-600 font-semibold">Total Distance</h3>
                        <i class="fas fa-road text-blue-500 text-2xl"></i>
                    </div>
                    <p class="text-2xl font-bold text-gray-800">{{ path_cost }} km</p>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-gray-600 font-semibold">Cities Visited</h3>
                        <i class="fas fa-map-pin text-red-500 text-2xl"></i>
                    </div>
                    <p class="text-2xl font-bold text-gray-800">{{ num_cities }}</p>
                </div>
            </div>

            <!-- Path Details -->
            <div class="bg-white rounded-2xl shadow-xl p-8 card-hover">
                <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-list-ol text-green-500 mr-3"></i>
                    Path Details
                </h3>
                <div class="text-gray-700 leading-relaxed">
                    {{ result | safe }}
                </div>
            </div>

            <!-- Map Toggle Button -->
            <div class="text-center">
                <button onclick="toggleMap()" 
                        class="btn-primary text-white font-bold py-4 px-8 rounded-lg inline-flex items-center">
                    <i class="fas fa-map mr-2"></i>
                    <span id="mapButtonText">Show on Map</span>
                </button>
            </div>

            <!-- Map Container -->
            <div id="mapContainer" class="map-container">
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-map-marked-alt text-purple-500 mr-3"></i>
                        Interactive Route Visualization
                    </h3>
                    <div id="map" style="height: 600px;"></div>
                    <div class="mt-4 flex gap-4 justify-center flex-wrap">
                        <div class="flex items-center">
                            <div class="w-4 h-4 bg-green-500 rounded-full mr-2"></div>
                            <span class="text-sm text-gray-600">Start City</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-4 h-4 bg-red-500 rounded-full mr-2"></div>
                            <span class="text-sm text-gray-600">Goal City</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-4 h-4 bg-blue-500 rounded-full mr-2"></div>
                            <span class="text-sm text-gray-600">Path Cities</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-4 h-4 bg-yellow-500 rounded-full mr-2 opacity-50"></div>
                            <span class="text-sm text-gray-600">Explored Cities</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-16">
        <div class="max-w-6xl mx-auto px-4 text-center">
            <p class="text-gray-300">
                <i class="fas fa-code mr-2"></i>
                Romania Path Finder - Powered by AI Search Algorithms
            </p>
            <p class="text-gray-400 text-sm mt-2">
                Visualizing BFS, DFS, A*, UCS, Greedy, DLS, and AO* algorithms
            </p>
        </div>
    </footer>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        let map = null;
        let routeLayer = null;
        let markersLayer = null;
        let mapInitialized = false;

        // Toggle algorithm-specific options
        function toggleOptions() {
            const algo = document.getElementById("algo").value;
            const depthInput = document.getElementById("depthLimitInput");
            const showOptionContainer = document.getElementById("showOptionContainer");
            
            depthInput.classList.toggle("hidden", algo !== "DLS");
            showOptionContainer.classList.toggle("hidden", algo !== "BFS" && algo !== "DFS");
        }

        // Initialize map
        function initMap() {
            if (mapInitialized) return;
            
            map = L.map('map').setView([45.9432, 24.9668], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            mapInitialized = true;
        }

        // Toggle map visibility
        function toggleMap() {
            const mapContainer = document.getElementById('mapContainer');
            const buttonText = document.getElementById('mapButtonText');
            
            if (mapContainer.classList.contains('show')) {
                mapContainer.classList.remove('show');
                buttonText.textContent = 'Show on Map';
            } else {
                mapContainer.classList.add('show');
                buttonText.textContent = 'Hide Map';
                
                if (!mapInitialized) {
                    initMap();
                    setTimeout(() => {
                        map.invalidateSize();
                        drawRoute();
                    }, 100);
                } else {
                    map.invalidateSize();
                }
            }
        }

        // Draw route on map with animation
        function drawRoute() {
            if (!map) return;

            // Clear previous layers
            if (routeLayer) map.removeLayer(routeLayer);
            if (markersLayer) map.removeLayer(markersLayer);

            const pathCoords = {{ path_coords | tojson | safe }};
            const exploredCoords = {{ explored_coords | tojson | safe }};

            if (pathCoords.length === 0) return;

            // Create layer groups
            routeLayer = L.layerGroup().addTo(map);
            markersLayer = L.layerGroup().addTo(map);

            // Draw explored nodes (in yellow with lower opacity)
            exploredCoords.forEach(coord => {
                L.circleMarker([coord[0], coord[1]], {
                    radius: 6,
                    fillColor: '#FCD34D',
                    color: '#F59E0B',
                    weight: 2,
                    opacity: 0.5,
                    fillOpacity: 0.3
                }).addTo(markersLayer);
            });

            // Convert coordinates for polyline
            const latlngs = pathCoords.map(c => [c[0], c[1]]);

            // Create animated polyline
            const polyline = L.polyline(latlngs, {
                color: '#667eea',
                weight: 4,
                opacity: 0.8,
                smoothFactor: 1
            }).addTo(routeLayer);

            // Animate polyline drawing
            let index = 0;
            const animatedLine = L.polyline([], {
                color: '#667eea',
                weight: 4,
                opacity: 0.8
            }).addTo(routeLayer);

            function animateLine() {
                if (index < latlngs.length) {
                    animatedLine.addLatLng(latlngs[index]);
                    index++;
                    setTimeout(animateLine, 200);
                }
            }
            polyline.remove();
            animateLine();

            // Add markers for path cities
            latlngs.forEach((coord, i) => {
                let color, icon;
                if (i === 0) {
                    color = '#10B981'; // Green for start
                    icon = 'fa-play-circle';
                } else if (i === latlngs.length - 1) {
                    color = '#EF4444'; // Red for goal
                    icon = 'fa-flag-checkered';
                } else {
                    color = '#3B82F6'; // Blue for intermediate
                    icon = 'fa-map-pin';
                }

                const marker = L.circleMarker(coord, {
                    radius: 8,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.9
                }).addTo(markersLayer);

                // Find city name
                const allCoords = {{ all_city_coords | tojson }};
                let cityName = '';
                for (const [city, coords] of Object.entries(allCoords)) {
                    if (Math.abs(coords[0] - coord[0]) < 0.01 && Math.abs(coords[1] - coord[1]) < 0.01) {
                        cityName = city;
                        break;
                    }
                }

                marker.bindPopup(`
                    <div class="text-center">
                        <i class="fas ${icon}" style="color: ${color}; font-size: 20px;"></i>
                        <p class="font-bold mt-2">${cityName}</p>
                        <p class="text-sm text-gray-600">Step ${i + 1}</p>
                    </div>
                `);

                // Open first and last popups briefly
                if (i === 0 || i === latlngs.length - 1) {
                    setTimeout(() => {
                        marker.openPopup();
                        setTimeout(() => marker.closePopup(), 2000);
                    }, index * 200 + 500);
                }
            });

            // Fit map to route bounds
            map.fitBounds(polyline.getBounds(), { padding: [50, 50] });
        }

        // Reset form
        function resetForm() {
            document.getElementById('pathForm').reset();
            const mapContainer = document.getElementById('mapContainer');
            if (mapContainer.classList.contains('show')) {
                mapContainer.classList.remove('show');
                document.getElementById('mapButtonText').textContent = 'Show on Map';
            }
            toggleOptions();
        }

        // Form submission with loading
        document.getElementById('pathForm').addEventListener('submit', function(e) {
            const spinner = document.getElementById('loadingSpinner');
            spinner.classList.remove('hidden');
            
            // Hide in case it was showing
            const mapContainer = document.getElementById('mapContainer');
            if (mapContainer.classList.contains('show')) {
                mapContainer.classList.remove('show');
            }
        });

        // Initialize on page load
        window.addEventListener('load', function() {
            toggleOptions();
            document.getElementById('algo').addEventListener('change', toggleOptions);
            
            // If results exist, auto-show map after a delay
            {% if result %}
            setTimeout(() => {
                const hasPath = {{ path_coords | length }};
                if (hasPath > 0) {
                    // Don't auto-show, let user click the button
                }
            }, 500);
            {% endif %}
        });
    </script>
</body>
</html>